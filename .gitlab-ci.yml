---
stages:
- Python Build
- Python Release

variables:
  ECR: 641143039263.dkr.ecr.eu-west-3.amazonaws.com
  IMAGE_NAME: equancy-datalake/framework

python-build:
  stage: Python Build
  image: 641143039263.dkr.ecr.eu-west-3.amazonaws.com/runner/ci-python:3.8
  script:
  - poetry build --format wheel --quiet
  cache:
    paths:
    - dist
    policy: push

python-release:
  stage: Python Release
  only:
  - tags
  image: 641143039263.dkr.ecr.eu-west-3.amazonaws.com/runner/ci-python:3.8
  script:
  - poetry config repositories.equancy https://nexus.apps.equancy.cloud/repository/equancy-python/
  - poetry publish -r equancy -u ${PYPI_USER} -p ${PYPI_PASSWORD}
  cache:
    paths:
    - dist
    policy: pull